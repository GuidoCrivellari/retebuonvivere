<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.link {
  stroke: #999;
  stroke-opacity: .6;
}

</style>
<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>



function drawGraph(graphData)
{

	console.log(graphData)

	force
	  .nodes(graphData.nodes)
	  .links(graphData.links)
	  .start();

	var link = svg.selectAll(".link")
	  .data(graphData.links)
	  .enter().append("line")
	  .attr("class", "link")
	  .style("stroke-width", 3);

	var node = svg.selectAll(".node")
	  .data(graphData.nodes)
	  .enter().append("line")
	  .attr("class", "node")
	  .attr("x1", function(d){return xForDate(d.start);})
	  .attr("x2", function(d){return xForDate(d.end);})
	  .attr("y1",function(d,i){return d.y;})
	  .attr("y2",function(d,i){return d.y;})
	//    .attr("stroke",function(d) { return color(d.group); })
	  .style("stroke-width", 3)
	  .style("stroke",function(d) { return color(d.group); })

	//   .style("fill", function(d) { return color(d.group); })
	  .call(force.drag);

	node.append("title")
	  .text(function(d) { return d.name; });

	force.on("tick", function() {
	link.attr("x1", function(d) { return xForDate(d.date); })
		.attr("y1", function(d) { return d.source.y; })
		.attr("x2", function(d) { return xForDate(d.date); })
		.attr("y2", function(d) { return d.target.y; });

	node.attr("y1",function(d,i){return d.y;})
		.attr("y2",function(d,i){return d.y;});
	});



	var x = d3.scale.linear()
		.domain([graphStartDate, now])
		.range([0, width]);


	var xAxis = d3.svg.axis()
		.scale(x)
		.tickSize(-height)
		.tickPadding(10)	
		.tickSubdivide(true)	
		.orient("bottom");	


	svg.append("g")
		.attr("class", "x axis")
	//    .attr("transform", "translate(0," + height + ")")
		.call(xAxis);

}




var graphStartDate=new Date(2005,1,1,0,0,0);  
var now=new Date();

var width = 1800,
    height = 700;

var pixelPerMs=width/(now.getTime()-graphStartDate.getTime());

function xForDate(date)
{
	return (date.getTime()-graphStartDate.getTime())*pixelPerMs;
}
      

var color = d3.scale.category20();

var force = d3.layout.force()
    .charge(-120)
    .linkDistance(100)
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);
    
    
var nodesFile="nodes.json";
var edgesFile="edges.json";


var nodes;
d3.json(nodesFile,function(error,parsed){
//		console.log(error);
//		console.log(parsed);
	
	nodes=parsed;
	
	var edgesOriginal;

	d3.json(edgesFile,function(error,parsed){
		edgesOriginal=parsed;
	
		var nodesIdMap=d3.map()
//		console.log(nodes)
		for (var i=0;i<nodes.length;i++)
		{
			var node=nodes[i];
			nodesIdMap.set(node["id"],i);
			if (isNaN(new Date(node["start"]).getTime()))
			{
			    node["start"]=graphStartDate;
			}
			else
			{
			    node["start"]=new Date(node["start"])
			}
			if (isNaN(new Date(node["end"]).getTime()))
			{
			    node["end"]=now;
			}
			else
			{
			    node["end"]=new Date(node["end"])
			}
			
		}

		var edges=[];

		for (var i=0;i<edgesOriginal.length;i++)
		{
			var edge=edgesOriginal[i];
			var startEdge={
							"source":	nodesIdMap.get(edge["source"]),
							"target":	nodesIdMap.get(edge["target"]),
							"date":		new Date(edge["start"]),
							"type":		"start",
							"label":	edge["label"],
							"url":		edge["url"]
							};
			edges.push(startEdge);

			if (edge["end"]!=edge["start"])
			{
			  var endEdge={
							  "source":	nodesIdMap.get(edge["target"]),
							  "target":	nodesIdMap.get(edge["source"]),
							  "date":		new Date(edge["end"]),
							  "type":		"end",
							  "label":	edge["label"],
							  "url":		edge["url"]
							  };
			  edges.push(endEdge);
			}
		}


		var graphData= {
							"links":edges,
							"nodes":nodes
						}


		drawGraph(graphData);












	})


})











 

</script>
